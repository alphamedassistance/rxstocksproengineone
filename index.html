<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RxStocks Pro ver. 1.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f4f7f6;
            --text-color: #333;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            color: var(--text-color); 
            line-height: 1.6;
        }

        .container { 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
            width: 100%;
            box-sizing: border-box;
        }

        .page-container { width: 100%; }
        
        /* Login Page */
        .login-page-container { 
            width: 100%; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }
        .login-container { width: 100%; display: flex; justify-content: center; }
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            box-sizing: border-box; 
        }
        .login-box h2 { margin-bottom: 20px; color: var(--primary-color); }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .input-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 16px; 
            box-sizing: border-box; 
        }
        .login-button-container { text-align: center; margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .login-timestamp-container { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 20px; color: #555; font-size: 14px; }
        
        .portal-links-container { margin-top: 25px; text-align: left; width: 100%; padding-top: 15px; border-top: 1px solid #eee; }
        .portal-link { display: block; text-decoration: none; color: var(--primary-color); font-size: 14px; margin-bottom: 12px; }
        
        /* Header */
        header { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { margin: 0; font-size: 1.25rem; text-align: center; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-controls { display: flex; align-items: center; gap: 10px; }

        /* Buttons */
        .btn { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 6px; 
            background-color: var(--primary-color); 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            transition: background-color 0.2s;
        }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: #6c757d; opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; } .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #212529; } .btn-warning:hover { background-color: #e0a800; }
        .btn-info { background-color: #17a2b8; } .btn-info:hover { background-color: #138496; }
        .btn-success { background-color: #28a745; } .btn-success:hover { background-color: #218838; }
        .btn-purple { background-color: #6f42c1; } .btn-purple:hover { background-color: #5a32a3; }
        .btn-sm { padding: 6px 10px; font-size: 12px; margin: 0; }
        
        /* Special Buttons */
        .invincible-admin-btn { width: 30px; height: 30px; background-color: transparent; border-radius: 50%; border: none; cursor: pointer; }
        .action-toggle-btn { font-size: 20px; background: none; border: none; cursor: pointer; padding: 5px; color: #007bff; }
        .btn-icon { background-color: transparent; border: none; color: var(--primary-color); font-size: 24px; cursor: pointer; }
        
        /* Layouts */
        .action-buttons { 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
        }
        
        .data-view-container { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); 
        }
        
        .table-header-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .search-container { 
            display: flex; 
            align-items: center; 
            flex-grow: 1; 
            gap: 8px; 
            width: 100%;
        }
        #searchInput { 
            flex-grow: 1; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-size: 14px; 
        }
        
        /* Table Styles */
        .table-wrapper { 
            overflow-x: auto; 
            border-radius: 6px;
            border: 1px solid #eee;
            -webkit-overflow-scrolling: touch; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; 
        }
        
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
        }
        
        th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: #495057; 
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        td:first-child { 
            white-space: normal; 
            min-width: 120px; 
            font-weight: 500;
        }
        
        td { white-space: nowrap; }

        .table-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            min-width: 180px; 
        }
        
        .table-actions .btn {
            flex: 1;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .pagination-container { margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .pagination-label { font-size: 14px; color: #666; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        .modal-content { 
            background-color: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); 
            width: 100%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-sizing: border-box;
            position: relative;
        }
        .modal-lg .modal-content { max-width: 900px; }
        .modal-content h2 { margin-top: 0; color: var(--primary-color); font-size: 1.5rem; margin-bottom: 20px; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; flex-wrap: wrap; }
        .modal-actions .btn { min-width: 80px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 16px;
            box-sizing: border-box; 
        }
        
        .error-message { color: #dc3545; margin-top: 5px; font-size: 13px; }
        
        /* PWA Install Button */
        .install-btn-container { margin-top: 15px; text-align: center; display: none; width: 100%; }
        .btn-install { background-color: #28a745; color: white; width: 100%; padding: 12px; margin-top: 10px; }
        
        /* Mobile Specific Tweaks */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .login-box { padding: 25px; }
            header { padding: 10px; }
            header h1 { font-size: 1.1rem; }
            .invincible-admin-btn { position: static; margin-right: auto; }
            .action-buttons .btn { flex: 1 1 calc(50% - 10px); font-size: 13px; padding: 10px 5px; }
            .table-header-controls { flex-direction: column; align-items: stretch; }
            .search-container { width: 100%; }
            #totalItems { text-align: center; margin-top: 5px; font-size: 0.9rem; }
            th, td { padding: 8px 6px; font-size: 13px; }
            .table-actions { flex-direction: row; } 
        }

        /* Loading Animation */
        .system-check-modal canvas { position: absolute; top: 0; left: 0; z-index: -1; }
        #loadingBox { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 10px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #progressBarContainer { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background-color: #28a745; transition: width 0.3s; }
    </style>
</head>
<body>
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <div id="login-page" class="login-page-container">
        <div class="login-container">
            <div class="login-box">
                <h2>RxStocks Pro ver. 1.0</h2>
                <div id="loginTimestamp" class="login-timestamp-container"></div>
                <form id="loginForm" autocomplete="off">
                    <div class="input-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" required placeholder="Enter username">
                    </div>
                    <div class="input-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required placeholder="Enter password">
                    </div>
                    <div class="login-button-container">
                        <button type="submit" class="btn" style="width: 100%;">Login</button>
                        <button type="button" id="enterCodeBtn" class="btn btn-secondary" style="width: 100%;">Enter Activation Code</button>
                    </div>
                    
                    <div id="pwaInstallContainer" class="install-btn-container">
                        <button type="button" id="pwaInstallBtn" class="btn btn-install">ðŸ“² Install App</button>
                    </div>
                    
                    <p id="login-error" class="error-message"></p>
                    <div class="portal-links-container">
                        <a href="https://alphamedassistance.github.io/portalmain/" class="portal-link"><span class="emoji">&#127760;</span> Web Portal</a>
                        <a href="https://m.me/61578341193853" class="portal-link"><span class="emoji">&#127911;</span> Request Assistance</a>
                    </div>
                </form>
            </div>
        </div>

        <div id="extensionCodeModal" class="modal">
            <div class="modal-content">
                <h2>Activate Application</h2>
                <p class="text-sm text-gray-500 mb-4">The application is currently frozen. Please enter a valid access code to activate it for 30 days.</p>
                <form id="extensionCodeForm">
                    <div class="form-group">
                        <label for="extensionCode">Access Code</label>
                        <input type="text" id="extensionCode" required autocomplete="off" placeholder="Enter code here...">
                    </div>
                    <p id="extension-code-error" class="error-message"></p>
                    <div class="modal-actions">
                        <button type="submit" id="submitCodeBtn" class="btn">Activate</button>
                        <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="inventory-page" class="page-container" style="display: none;">
        <header>
            <button class="invincible-admin-btn" title="Admin Options"></button>
            <h1>RxStocks Pro ver. 1.0</h1>
            <div class="header-controls">
                <button id="logoutBtn" class="btn btn-danger btn-sm">Log Out</button>
            </div>
        </header>

        <main class="container">
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button id="registerBtn" class="btn">Register Item</button>
                <button id="viewListBtn" class="btn">Full List</button>
                <button id="dpmBtn" class="btn">Product Movement</button>
                <button id="refillMonitoringBtn" class="btn btn-purple">Refill Monitoring</button>
                <button id="dispenseListBtn" class="btn">Replacements</button>
                <button id="dispensedLogBtn" class="btn">Dispensed Items</button> 
                <button id="expirationBtn" class="btn btn-danger">Expirations</button>
                <button id="exportBtnText" class="btn btn-secondary">Export Text</button>
                <button id="exportBtnFile" class="btn btn-info">Export File</button>
                <button id="importBtnText" class="btn btn-secondary">Import Text</button>
                <button id="importBtnFile" class="btn btn-info">Import File</button>
            </div>

            <div class="data-view-container">
                <div class="table-header-controls">
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Search by item name...">
                        <button class="action-toggle-btn" id="toggleActionsBtn" title="Toggle Action Buttons">&#9670;</button>
                    </div>
                    <h3 id="totalItems" style="margin: 0; font-size: 1rem;">Total Items: 0</h3>
                </div>

                <div id="timestamp" class="timestamp-display" style="text-align: right; margin-bottom: 10px; font-size: 12px; color: #666;"></div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Current Qty</th>
                                <th>Total Stocks</th> <th>Price</th>
                                <th>Expiry</th>
                                <th>Reg. Date</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>
                <div class="pagination-container">
                    <div class="pagination-controls">
                        <button id="prevPageBtn" class="btn btn-secondary btn-sm">Previous</button>
                        <span id="pageInfo" class="pagination-label">Page 1 of 1</span>
                        <button id="nextPageBtn" class="btn btn-secondary btn-sm">Next</button>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="itemModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">Register New Item</h2>
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    <div class="form-group"><label>Item Name</label><input type="text" id="itemName" maxlength="100" required></div>
                    
                    <div class="form-group"><label>Total Stocks</label><input type="number" id="quantity" min="0" max="999999" required></div>
                    
                    <div class="form-group" id="currentQtyContainer" style="display:none; background-color: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px dashed #ccc;">
                        <label>Current Quantity (Actual)</label>
                        <input type="number" id="currentQuantity" min="0" max="999999">
                        <small style="color:#666; font-size: 11px;">Modify this only if actual count mismatches system.</small>
                    </div>

                    <div class="form-group"><label>Unit Price (â‚±)</label><input type="number" id="unitPrice" min="0" max="999999" step="0.01" required></div>
                    <div class="form-group"><label>Expiration Date</label><input type="date" id="expirationDate"></div>
                    <div class="form-group"><label>Date of Registration</label><input type="date" id="registrationDate" required></div>
                    <p id="item-form-error" class="error-message"></p>
                    <div class="modal-actions"><button type="submit" class="btn">Save</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
                </form>
            </div>
        </div>

        <div id="viewListModal" class="modal">
            <div class="modal-content modal-lg">
                <h2>Full Item List</h2>
                <div id="fullItemList" class="scrollable-list" style="max-height: 400px; overflow-y: auto;"></div>
                <div class="pagination-container"><div class="pagination-controls"><button id="fullListPrevBtn" class="btn btn-sm">Previous</button><button id="fullListNextBtn" class="btn btn-sm">Next</button></div><span id="fullListPageInfo" class="pagination-label">Page 1 of 1</span></div>
                <div class="modal-actions"><button type="button" id="downloadFullListPdfBtn" class="btn btn-info">Download PDF</button><button type="button" class="btn btn-secondary cancel-btn">Close</button></div>
            </div>
        </div>

        <div id="dispenseListModal" class="modal">
            <div class="modal-content modal-lg">
                <h2>Items for Replacement</h2>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Items appear here when Current Qty < Total Stocks.</p>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Current Qty</th>
                                <th>Total Stocks</th> <th>Dispense (Needed)</th> 
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dispenseListBody"></tbody>
                    </table>
                </div>
                <div class="pagination-container">
                    <div class="pagination-controls">
                        <button id="dispenseListPrevBtn" class="btn btn-sm">Previous</button>
                        <span id="dispenseListPageInfo" class="pagination-label">Page 1 of 1</span>
                        <button id="dispenseListNextBtn" class="btn btn-sm">Next</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="downloadDispenseListPdfBtn" class="btn btn-info">Download PDF</button>
                    <button type="button" class="btn btn-secondary cancel-btn">Close</button>
                </div>
            </div>
        </div>

        <div id="dispensedLogModal" class="modal">
            <div class="modal-content modal-lg">
                <h2>Dispensed History</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Qty Dispensed</th>
                            </tr>
                        </thead>
                        <tbody id="dispensedLogBody"></tbody>
                    </table>
                </div>
                <div class="pagination-container">
                    <div class="pagination-controls">
                        <button id="dispensedLogPrevBtn" class="btn btn-sm">Previous</button>
                        <span id="dispensedLogPageInfo" class="pagination-label">Page 1 of 1</span>
                        <button id="dispensedLogNextBtn" class="btn btn-sm">Next</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="downloadDispensedLogPdfBtn" class="btn btn-info">Download PDF</button>
                    <button type="button" class="btn btn-secondary cancel-btn">Close</button>
                </div>
            </div>
        </div>

        <div id="refillLogModal" class="modal">
            <div class="modal-content modal-lg">
                <h2>Refill Monitoring Logs</h2>
                <p style="font-size: 0.85rem; color: #666;">Records of stock increases via Edit menu.</p>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Date/Time</th>
                                <th>Action / Current No.</th>
                                <th>Added</th>
                                <th>New Qty</th>
                            </tr>
                        </thead>
                        <tbody id="refillLogBody"></tbody>
                    </table>
                </div>
                <div class="pagination-container">
                    <div class="pagination-controls">
                        <button id="refillLogPrevBtn" class="btn btn-sm">Previous</button>
                        <span id="refillLogPageInfo" class="pagination-label">Page 1 of 1</span>
                        <button id="refillLogNextBtn" class="btn btn-sm">Next</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="downloadRefillLogPdfBtn" class="btn btn-info">Download PDF</button>
                    <button type="button" class="btn btn-secondary cancel-btn">Close</button>
                </div>
            </div>
        </div>
        
        <div id="expirationModal" class="modal">
            <div class="modal-content modal-lg">
                <h2>Expired & Nearing Expiration (10 Days)</h2>
                <div class="form-group"><input type="text" id="expirationSearchInput" placeholder="Search expiring items..."></div>
                <div class="table-wrapper"><table><thead><tr><th>Item Name</th><th>Expiration Date</th><th>Action</th></tr></thead><tbody id="expirationListBody"></tbody></table></div>
                <div class="pagination-container"><div class="pagination-controls"><button id="expirationPrevBtn" class="btn btn-sm">Previous</button><button id="expirationNextBtn" class="btn btn-sm">Next</button></div><span id="expirationPageInfo" class="pagination-label">Page 1 of 1</span></div>
                <div class="modal-actions"><button type="button" id="downloadExpirationPdfBtn" class="btn btn-info">Download PDF</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
            </div>
        </div>

        <div id="dispenseModal" class="modal">
            <div class="modal-content">
                <h2>Dispense Item</h2>
                <form id="dispenseForm">
                    <p>Item: <strong id="dispenseItemName"></strong></p><p>Available: <strong id="dispenseAvailableQty"></strong></p>
                    <div class="form-group"><label>Quantity to Dispense</label><input type="number" id="dispenseQuantity" min="1" max="999999" required></div>
                    <p id="dispense-error" class="error-message"></p>
                    <div class="modal-actions"><button type="submit" class="btn">Dispense</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
                </form>
            </div>
        </div>
        
        <div id="dpmModal" class="modal">
            <div class="modal-content modal-lg">
                <h2>Daily Product Movement</h2>
                <div class="dpm-controls" style="display: flex; gap: 10px; flex-wrap: wrap;"><div class="form-group" style="flex-grow: 1;"><label>Select a Date:</label><input type="date" id="dpmDateInput" required></div><button id="dpmDateBtn" class="btn" style="height: fit-content; align-self: flex-end; margin-bottom: 15px;">Show Report</button></div><hr>
                <div id="dpmContent" style="overflow-x: auto;"></div>
                <div class="dpm-pagination-controls" style="display: none;"><div class="pagination"><button id="dpmPrevPageBtn" class="btn btn-sm">Previous</button><span id="dpmPageInfo">Page 1 of 1</span><button id="dpmNextPageBtn" class="btn btn-sm">Next</button></div></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary cancel-btn">Close</button></div>
            </div>
        </div>
        
        <div id="importTextModal" class="modal">
            <div class="modal-content">
                <h2>Import from Backup Text</h2>
                <div class="form-group"><label>Paste your backup data here:</label><textarea id="importDataText" rows="10"></textarea></div>
                <div class="modal-actions"><button type="button" id="loadTextBtn" class="btn">Load Backup</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
            </div>
        </div>

        <div id="adminPasswordModal" class="modal">
            <div class="modal-content">
                <h2>Admin Security</h2>
                <form id="adminPasswordForm">
                    <div class="form-group"><label>Type your security password</label><input type="password" id="adminPassword" required></div>
                    <p id="admin-password-error" class="error-message"></p>
                    <div class="modal-actions"><button type="submit" class="btn">Enter</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
                </form>
            </div>
        </div>

        <div id="adminOptionsModal" class="modal">
            <div class="modal-content">
                <h2>System Progress</h2>
                <form id="adminOptionsForm">
                    <div class="form-group-toggle"><button id="toggleDateInputsBtn" type="button" class="btn btn-icon">&#10148;</button></div>
                    <div id="dateInputs" style="display:none;">
                        <div class="form-group"><label>Progress Start</label><input type="datetime-local" id="timerStartDate" required></div>
                        <div class="form-group"><label>Progress End</label><input type="datetime-local" id="timerEndDate" required></div>
                    </div>
                    <p id="admin-options-error" class="error-message"></p>
                    <div id="countdownDisplay" style="display: none; text-align: center; margin: 10px 0; font-weight: bold;"><span id="countdownLabel">Progress will freeze in:</span><div id="countdownTimer" style="font-size: 1.2rem; color: #007bff;"></div></div>
                    <div class="modal-actions">
                        <button id="toggleCountdownBtn" type="button" class="btn btn-icon">&#9670;</button>
                        <button type="submit" class="btn">Start</button>
                        <button type="button" id="stopTimerBtn" class="btn btn-warning">Stop</button>
                        <button type="button" id="codeCheckerBtn" class="btn btn-success">Check</button>
                        <button type="button" id="clearDataBtn" class="btn btn-danger">Clear Data</button>
                        <button type="button" class="btn btn-secondary cancel-btn">Close</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="clearDataPasswordModal" class="modal">
            <div class="modal-content">
                <h2>Confirm Data Deletion</h2>
                <p><strong>DANGER:</strong> This will permanently erase ALL data.</p>
                <form id="clearDataForm">
                    <div class="form-group"><label>Password</label><input type="password" id="clearDataPassword" required></div>
                    <p id="clear-data-error" class="error-message"></p>
                    <div class="modal-actions"><button type="submit" class="btn btn-danger">Confirm</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
                </form>
            </div>
        </div>

        <div id="expirationPasswordModal" class="modal">
            <div class="modal-content">
                <h2>Confirm Removal</h2>
                <form id="expirationPasswordForm">
                    <div class="form-group"><label>Password</label><input type="password" id="expirationItemPassword" required></div>
                    <p id="expiration-item-error" class="error-message"></p>
                    <div class="modal-actions"><button type="submit" class="btn">Confirm</button><button type="button" class="btn btn-secondary cancel-btn">Cancel</button></div>
                </form>
            </div>
        </div>
        
        <div id="manualCopyModal" class="modal">
            <div class="modal-content">
                <h2>Copy Data Manually</h2>
                <div class="form-group"><textarea id="manualCopyText" rows="15" readonly></textarea></div>
                <div class="modal-actions"><button type="button" id="selectAllBtn" class="btn btn-primary">Select All</button><button type="button" class="btn btn-secondary cancel-btn">Close</button></div>
            </div>
        </div>

        <div id="systemCheckModal" class="modal system-check-modal">
            <canvas id="matrixCanvas"></canvas>
            <div id="loadingBox">
                <h3 id="loadingStatusText">Initializing System Scan...</h3>
                <div id="progressBarContainer"><div id="progressBar"></div></div>
                <p id="loadingPercentage">0%</p>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = "https://wmciiqeywkluzkslzsrq.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtY2lpcWV5d2tsdXprc2x6c3JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDk0MjksImV4cCI6MjA3OTgyNTQyOX0.qVXO8GcXW8AsjWT4N-zkfW5B0g5qijoPX2mOZc4btVQ";
        
        let supabase = null;
        try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); console.log("Supabase initialized."); } catch (err) { console.error("Supabase Init Error", err); }

        // --- PWA LOGIC ---
        let deferredPrompt;
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
                    .catch(err => { console.log('ServiceWorker registration failed: ', err); });
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installContainer = document.getElementById('pwaInstallContainer');
            if(installContainer) {
                installContainer.style.display = 'block';
                const installBtn = document.getElementById('pwaInstallBtn');
                installBtn.addEventListener('click', async () => {
                    installContainer.style.display = 'none';
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                });
            }
        });

        window.addEventListener('appinstalled', () => {
            const installContainer = document.getElementById('pwaInstallContainer');
            if(installContainer) installContainer.style.display = 'none';
            deferredPrompt = null;
            console.log('PWA was installed');
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // --- INDEXEDDB HELPER ---
            const db = {
                _db: null,
                init: function() { 
                    return new Promise((res, rej) => { 
                        // INCREASED DB VERSION TO 4 TO ADD REFILL LOG STORE
                        const req = indexedDB.open('InventoryDB', 4); 
                        req.onupgradeneeded = (e) => { 
                            const db = e.target.result; 
                            if (!db.objectStoreNames.contains('items')) { 
                                db.createObjectStore('items', { keyPath: 'id' }).createIndex('name', 'name', { unique: false }); 
                            } 
                            if (!db.objectStoreNames.contains('dispenseLog')) { 
                                const ls = db.createObjectStore('dispenseLog', { autoIncrement: true }); 
                                ls.createIndex('dispenseDate', 'dispenseDate', { unique: false }); 
                                ls.createIndex('dispenseDateLocal', 'dispenseDateLocal', { unique: false }); 
                            }
                            if (!db.objectStoreNames.contains('refillLog')) {
                                const rs = db.createObjectStore('refillLog', { autoIncrement: true });
                                rs.createIndex('date', 'date', { unique: false });
                            }
                        }; 
                        req.onsuccess = (e) => { this._db = e.target.result; res(); }; 
                        req.onerror = (e) => rej(e.target.errorCode); 
                    }); 
                },
                _getStore: function(n, m) { return this._db.transaction(n, m).objectStore(n); },
                addItem: function(i) { return new Promise((res, rej) => { const r = this._getStore('items', 'readwrite').add(i); r.onsuccess = res; r.onerror = rej; }); },
                updateItem: function(i) { return new Promise((res, rej) => { const r = this._getStore('items', 'readwrite').put(i); r.onsuccess = res; r.onerror = rej; }); },
                deleteItem: function(id) { return new Promise((res, rej) => { const r = this._getStore('items', 'readwrite').delete(id); r.onsuccess = res; r.onerror = rej; }); },
                getItem: function(id) { return new Promise((res, rej) => { const r = this._getStore('items', 'readonly').get(id); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
                getAllItems: function() { return new Promise((res, rej) => { const r = this._getStore('items', 'readonly').getAll(); r.onsuccess = () => res(r.result.sort((a,b) => b.id - a.id)); r.onerror = rej; }); },
                addDispenseLog: function(l) { return new Promise((res, rej) => { const r = this._getStore('dispenseLog', 'readwrite').add(l); r.onsuccess = res; r.onerror = rej; }); },
                getAllDispenseLogs: function() { return new Promise((res, rej) => { const r = this._getStore('dispenseLog', 'readonly').getAll(); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
                getDispenseLogByDate: function(d) { return new Promise((res, rej) => { const r = this._getStore('dispenseLog', 'readonly').index('dispenseDateLocal').getAll(d); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
                // NEW: REFILL LOG METHODS
                addRefillLog: function(l) { return new Promise((res, rej) => { const r = this._getStore('refillLog', 'readwrite').add(l); r.onsuccess = res; r.onerror = rej; }); },
                getAllRefillLogs: function() { return new Promise((res, rej) => { const r = this._getStore('refillLog', 'readonly').getAll(); r.onsuccess = () => res(r.result); r.onerror = rej; }); },
                
                deleteDispenseLogByDate: function(d) { return new Promise((res, rej) => { const req = this._getStore('dispenseLog', 'readwrite').index('dispenseDateLocal').openCursor(d); req.onsuccess = (e) => { const c = e.target.result; if(c) { c.delete(); c.continue(); } else res(); }; req.onerror = rej; }); },
                clearStore: function(n) { return new Promise((res, rej) => { const r = this._getStore(n, 'readwrite').clear(); r.onsuccess = res; r.onerror = rej; }); },
                bulkAdd: function(n, d) { return new Promise((res, rej) => { const s = this._getStore(n, 'readwrite'); d.forEach(i => s.put(i)); s.transaction.oncomplete = res; s.transaction.onerror = rej; }); },
            };

            // --- NAVIGATION & TIMESTAMP ---
            let timestampInterval = null;
            const loginPage = document.getElementById('login-page');
            const inventoryPage = document.getElementById('inventory-page');
            const showInventoryPage = () => { loginPage.style.display = 'none'; inventoryPage.style.display = 'block'; updateTimestamp(); if(!timestampInterval) timestampInterval = setInterval(updateTimestamp, 1000); };
            const showLoginPage = () => { loginPage.style.display = 'flex'; inventoryPage.style.display = 'none'; clearInterval(timestampInterval); timestampInterval = null; };
            const updateTimestamp = () => { const now = new Date(); const d = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); const t = now.toLocaleTimeString('en-US', { hour12: true, hour: 'numeric', minute: '2-digit', second: '2-digit' }); document.getElementById('timestamp').innerHTML = `${d}<br>${t}`; document.getElementById('loginTimestamp').innerHTML = `<span>${d}</span> <span>${t}</span>`; };

            // --- FREEZE/ACTIVATE LOGIC ---
            const freezeUI = () => document.querySelectorAll('#registerBtn, #viewListBtn, #dpmBtn, #dispenseListBtn, #dispensedLogBtn, #expirationBtn, #exportBtnText, #exportBtnFile, #importBtnText, #importBtnFile, #refillMonitoringBtn, .edit-btn, .dispense-btn, .delete-btn').forEach(btn => btn.disabled = true);
            const unfreezeUI = () => document.querySelectorAll('#registerBtn, #viewListBtn, #dpmBtn, #dispenseListBtn, #dispensedLogBtn, #expirationBtn, #exportBtnText, #exportBtnFile, #importBtnText, #importBtnFile, #refillMonitoringBtn, .edit-btn, .dispense-btn, .delete-btn').forEach(btn => btn.disabled = false);
            const applyUIState = () => { if (localStorage.getItem('appStatus') === 'stopped') { freezeUI(); console.log("Frozen"); } else { unfreezeUI(); console.log("Active"); } };

            const handleActivation = async (e) => {
                e.preventDefault(); const btn = document.getElementById('submitCodeBtn'); const codeInput = document.getElementById('extensionCode'); const errorEl = document.getElementById('extension-code-error'); const userCode = codeInput.value.trim().toUpperCase();
                if (!userCode) { errorEl.textContent = 'Enter code.'; return; }
                btn.textContent = 'Verifying...'; btn.disabled = true; errorEl.textContent = '';
                try {
                    const { data, error } = await supabase.from('access_codes').select('*').eq('code', userCode).single();
                    if (error || !data) throw new Error("Invalid Code");
                    if (data.status !== 'available') throw new Error("Code used.");
                    const { error: updateError } = await supabase.from('access_codes').update({ status: 'used' }).eq('id', data.id);
                    if (updateError) throw updateError;
                    
                    const newExp = new Date(); newExp.setDate(newExp.getDate() + 30);
                    localStorage.setItem('appExpiration', newExp.getTime()); localStorage.setItem('appStatus', 'running');
                    if (countdownInterval) clearInterval(countdownInterval); countdownInterval = setInterval(updateCountdownDisplay, 1000); updateCountdownDisplay(); applyUIState();
                    alert('Activated for 30 days.'); document.getElementById('extensionCodeModal').style.display = 'none'; codeInput.value = '';
                } catch (err) { errorEl.textContent = err.message || "Failed."; } finally { btn.textContent = 'Activate'; btn.disabled = false; }
            };
            document.getElementById('extensionCodeForm').addEventListener('submit', handleActivation);
            document.getElementById('enterCodeBtn').addEventListener('click', () => { document.getElementById('extensionCodeModal').style.display = 'flex'; });

            // --- LOGIN ---
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault(); const u = document.getElementById('username').value.trim(); const p = document.getElementById('password').value;
                if (u === 'account1' && p === 'store2025') { sessionStorage.setItem('loggedIn', 'true'); showInventoryPage(); await refreshAndRenderTable(); checkExpirationOnLoad(); } 
                else { document.getElementById('login-error').textContent = 'Invalid credentials'; }
            });

            // --- TIMER ---
            let countdownInterval = null;
            const updateCountdownDisplay = () => {
                const exp = localStorage.getItem('appExpiration'); const display = document.getElementById('countdownTimer');
                if (!exp) { display.textContent = ""; return; }
                const rem = parseInt(exp) - Date.now();
                if (rem <= 0) {
                    document.getElementById('countdownLabel').textContent = "EXPIRED"; display.textContent = "";
                    if (localStorage.getItem('appStatus') !== 'stopped') { localStorage.setItem('appStatus', 'stopped'); applyUIState(); alert("Expired. Frozen."); }
                } else {
                    document.getElementById('countdownLabel').textContent = "Expires in:";
                    display.textContent = `${Math.floor(rem / 86400000)}d ${Math.floor((rem % 86400000) / 3600000)}h`;
                }
            };
            const checkExpirationOnLoad = async () => {
                if (!localStorage.getItem('appInitialized')) { localStorage.setItem('appStatus', 'stopped'); localStorage.setItem('appInitialized', 'true'); }
                const exp = localStorage.getItem('appExpiration');
                if (exp && Date.now() >= parseInt(exp)) localStorage.setItem('appStatus', 'stopped');
                else if (exp) { if (countdownInterval) clearInterval(countdownInterval); countdownInterval = setInterval(updateCountdownDisplay, 1000); }
                applyUIState(); updateCountdownDisplay();
            };

            // --- INVENTORY UI & LOGIC ---
            // ALL PAGINATION LIMITED TO 10
            let currentPage = 1, itemsPerPage = 10; 
            const tableBody = document.getElementById('inventoryTableBody');
            
            // Toggle Buttons
            const toggleBtn = document.getElementById('toggleActionsBtn');
            const actionContainer = document.getElementById('actionButtons');
            toggleBtn.addEventListener('click', () => {
                const isHidden = actionContainer.style.display === 'none';
                actionContainer.style.display = isHidden ? 'flex' : 'none';
                toggleBtn.innerHTML = isHidden ? '&#9670;' : '&#9671;';
            });

            const refreshAndRenderTable = async () => { const inv = await db.getAllItems(); renderTable(inv); };
            const renderTable = (inv) => {
                tableBody.innerHTML = ''; const term = document.getElementById('searchInput').value.toLowerCase();
                const filtered = inv.filter(i => i.name.toLowerCase().includes(term));
                const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
                currentPage = Math.min(currentPage, totalPages);
                const start = (currentPage - 1) * itemsPerPage;
                const pageItems = filtered.slice(start, start + itemsPerPage);
                
                pageItems.forEach(i => {
                    const tr = document.createElement('tr');
                    // Logic to handle old items that might not have totalStock explicitly set yet
                    const totalStocks = i.totalStock !== undefined ? i.totalStock : (i.initialStock !== undefined ? i.initialStock : i.quantity);

                    tr.innerHTML = `<td>${i.name}</td><td>${i.quantity}</td><td>${totalStocks}</td><td>â‚±${parseFloat(i.unitPrice).toFixed(2)}</td><td>${i.expirationDate || 'N/A'}</td><td>${i.registrationDate}</td><td><div class="table-actions"><button class="btn btn-sm edit-btn" data-id="${i.id}">Edit</button><button class="btn btn-sm dispense-btn" data-id="${i.id}">Dispense</button><button class="btn btn-sm btn-danger delete-btn" data-id="${i.id}">Delete</button></div></td>`;
                    tableBody.appendChild(tr);
                });
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
                document.getElementById('totalItems').textContent = `Total Items: ${new Set(inv.map(i=>i.name)).size}`;
                applyUIState();
            };

            document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; refreshAndRenderTable(); });
            document.getElementById('prevPageBtn').addEventListener('click', () => { if(currentPage > 1) { currentPage--; refreshAndRenderTable(); }});
            document.getElementById('nextPageBtn').addEventListener('click', async () => { const i = await db.getAllItems(); if(currentPage < Math.ceil(i.length/itemsPerPage)) { currentPage++; refreshAndRenderTable(); }});
            document.getElementById('logoutBtn').addEventListener('click', () => { sessionStorage.removeItem('loggedIn'); document.getElementById('loginForm').reset(); showLoginPage(); });

            // Modal Toggles
            const showModal = (m) => m.style.display = 'flex';
            const hideModal = (m) => { m.style.display = 'none'; m.querySelectorAll('form').forEach(f=>f.reset()); m.querySelectorAll('.error-message').forEach(e=>e.textContent=''); };
            document.querySelectorAll('.modal').forEach(m => { m.addEventListener('click', e => { if(e.target===m) hideModal(m); }); m.querySelector('.cancel-btn')?.addEventListener('click', ()=>hideModal(m)); });

            // Admin Logic
            const adminBtn = document.querySelector('.invincible-admin-btn');
            adminBtn.addEventListener('click', () => showModal(document.getElementById('adminPasswordModal')));
            document.getElementById('adminPasswordForm').addEventListener('submit', (e) => {
                e.preventDefault(); const p = document.getElementById('adminPassword').value;
                if(p === 'urielllamasadmin2025') { hideModal(document.getElementById('adminPasswordModal')); showModal(document.getElementById('adminOptionsModal')); }
                else document.getElementById('admin-password-error').textContent = "Incorrect.";
            });
            document.getElementById('toggleDateInputsBtn').addEventListener('click', () => { document.getElementById('dateInputs').style.display = document.getElementById('dateInputs').style.display === 'none' ? 'block' : 'none'; });
            document.getElementById('toggleCountdownBtn').addEventListener('click', () => { document.getElementById('countdownDisplay').style.display = document.getElementById('countdownDisplay').style.display === 'none' ? 'block' : 'none'; });

            document.getElementById('adminOptionsForm').addEventListener('submit', (e) => {
                e.preventDefault(); const s = document.getElementById('timerStartDate').value; const end = document.getElementById('timerEndDate').value;
                if(!s || !end) return;
                const exp = new Date(end).getTime(); localStorage.setItem('appExpiration', exp); localStorage.setItem('appStatus', 'running');
                if(countdownInterval) clearInterval(countdownInterval); countdownInterval = setInterval(updateCountdownDisplay, 1000); updateCountdownDisplay(); applyUIState();
                alert('Progress started.'); hideModal(document.getElementById('adminOptionsModal'));
            });
            document.getElementById('stopTimerBtn').addEventListener('click', () => { localStorage.setItem('appStatus', 'stopped'); localStorage.removeItem('appExpiration'); applyUIState(); updateCountdownDisplay(); alert('Stopped.'); });
            document.getElementById('clearDataBtn').addEventListener('click', () => showModal(document.getElementById('clearDataPasswordModal')));
            document.getElementById('clearDataForm').addEventListener('submit', async (e) => {
                e.preventDefault(); if(document.getElementById('clearDataPassword').value === 'urielllamasadmin2025') {
                    await db.clearStore('items'); await db.clearStore('dispenseLog'); await db.clearStore('refillLog'); hideModal(document.getElementById('clearDataPasswordModal')); hideModal(document.getElementById('adminOptionsModal')); refreshAndRenderTable(); alert('Data cleared.');
                } else document.getElementById('clear-data-error').textContent = "Incorrect.";
            });

            // Register & Actions
            document.getElementById('registerBtn').addEventListener('click', () => { 
                document.getElementById('modalTitle').textContent='Register New Item'; 
                document.getElementById('registrationDate').valueAsDate=new Date(); 
                document.getElementById('currentQtyContainer').style.display = 'none'; // Hide current qty on register
                document.getElementById('currentQuantity').required = false;
                showModal(document.getElementById('itemModal')); 
            });
            
            document.getElementById('itemForm').addEventListener('submit', async (e) => {
                e.preventDefault(); 
                
                // --- 1. CAPITALIZE FIRST LETTER LOGIC ---
                let n = document.getElementById('itemName').value.trim(); 
                if(n.length > 0) {
                    n = n.charAt(0).toUpperCase() + n.slice(1);
                }

                // --- 2. CHECK DUPLICATE LOGIC ---
                const idStr = document.getElementById('itemId').value;
                const currentId = idStr ? parseInt(idStr) : null;
                
                // Get all items to check for duplicates
                const allItems = await db.getAllItems();
                // Check if name exists (case-insensitive), excluding the current item if editing
                const isDuplicate = allItems.some(i => i.name.toLowerCase() === n.toLowerCase() && i.id !== currentId);

                if (isDuplicate) {
                    alert('Error: An item with this name already exists. Please use a unique name.');
                    return; // Stop function execution, do not save
                }

                // The input id 'quantity' represents TOTAL STOCKS
                const totalStockInput = parseInt(document.getElementById('quantity').value); 
                const p = parseFloat(document.getElementById('unitPrice').value); 
                const ex = document.getElementById('expirationDate').value; 
                const r = document.getElementById('registrationDate').value; 
                const currentQtyInput = document.getElementById('currentQuantity').value;

                if(!n || totalStockInput<0 || p<0) return;

                if(currentId) { 
                    // --- UPDATE ITEM (EDIT MODE) ---
                    const item = await db.getItem(currentId); 
                    const oldQty = item.quantity;
                    // Logic to get previous Total Stock safely
                    const oldTotal = item.totalStock !== undefined ? item.totalStock : (item.initialStock || item.quantity);

                    const newCurrentQty = currentQtyInput !== "" ? parseInt(currentQtyInput) : item.quantity;
                    
                    // Constraint Check
                    if (newCurrentQty > totalStockInput) {
                        alert(`Current Quantity (${newCurrentQty}) cannot be greater than Total Stocks (${totalStockInput}).`);
                        return;
                    }

                    // --- NEW REFILL MONITORING LOGIC ---
                    // Calculate exact differences
                    const qtyDifference = newCurrentQty - oldQty;
                    const totalStockDifference = totalStockInput - oldTotal;

                    // If Current Quantity Increased
                    if (qtyDifference > 0) {
                        await db.addRefillLog({
                            itemId: item.id,
                            itemName: n,
                            date: new Date().toISOString(),
                            action: `Current Qty (Prev: ${oldQty})`, // Action / Current No.
                            addedQty: qtyDifference,                 // Added
                            newQty: newCurrentQty                    // New Qty
                        });
                    }

                    // If Total Stock Increased
                    if (totalStockDifference > 0) {
                        await db.addRefillLog({
                            itemId: item.id,
                            itemName: n,
                            date: new Date().toISOString(),
                            action: `Total Stocks (Prev: ${oldTotal})`, // Action / Current No.
                            addedQty: totalStockDifference,             // Added
                            newQty: totalStockInput                     // New Qty (New Limit)
                        });
                    }

                    await db.updateItem({
                        ...item, 
                        name:n, 
                        quantity: newCurrentQty, 
                        totalStock: totalStockInput, 
                        initialStock: totalStockInput, 
                        unitPrice:p, 
                        expirationDate:ex, 
                        registrationDate:r
                    }); 
                }
                else { 
                    // --- NEW ITEM (REGISTRATION MODE) ---
                    await db.addItem({ 
                        id: Date.now(), 
                        name:n, 
                        quantity: totalStockInput, 
                        totalStock: totalStockInput, 
                        initialStock: totalStockInput, 
                        unitPrice:p, 
                        expirationDate:ex, 
                        registrationDate:r
                    }); 
                }
                hideModal(document.getElementById('itemModal')); refreshAndRenderTable();
            });

            tableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('button'); if(!button) return; const id = parseInt(button.dataset.id); if(!id) return;
                if(button.classList.contains('delete-btn')) { if(confirm('Delete?')) { await db.deleteItem(id); refreshAndRenderTable(); } }
                else if (button.classList.contains('edit-btn')) { 
                    const i = await db.getItem(id); 
                    document.getElementById('itemId').value=i.id; 
                    document.getElementById('itemName').value=i.name; 
                    
                    // Determine Total Stock (Legacy fallback)
                    const ts = i.totalStock !== undefined ? i.totalStock : (i.initialStock !== undefined ? i.initialStock : i.quantity);
                    
                    document.getElementById('quantity').value = ts; // "Total Stocks" Input
                    
                    // Show and populate Current Quantity Field
                    const qtyContainer = document.getElementById('currentQtyContainer');
                    qtyContainer.style.display = 'block';
                    document.getElementById('currentQuantity').value = i.quantity;
                    
                    document.getElementById('unitPrice').value=i.unitPrice; 
                    document.getElementById('expirationDate').value=i.expirationDate; 
                    document.getElementById('registrationDate').value=i.registrationDate; 
                    document.getElementById('modalTitle').textContent='Edit Item'; 
                    showModal(document.getElementById('itemModal')); 
                }
                else if (button.classList.contains('dispense-btn')) { const i = await db.getItem(id); document.getElementById('dispenseItemName').textContent=i.name; document.getElementById('dispenseAvailableQty').textContent=i.quantity; document.getElementById('dispenseQuantity').max=i.quantity; document.getElementById('dispenseForm').dataset.id=id; showModal(document.getElementById('dispenseModal')); }
            });

            document.getElementById('dispenseForm').addEventListener('submit', async (e) => {
                e.preventDefault(); const id = parseInt(e.target.dataset.id); const qty = parseInt(document.getElementById('dispenseQuantity').value);
                const item = await db.getItem(id); if(qty > item.quantity) return;
                
                // Dispense Logic: Reduce Quantity, DO NOT Change Total Stock
                item.quantity -= qty; 
                // Ensure legacy fields don't break logic
                if(item.totalStock === undefined) { item.totalStock = (item.quantity + qty); }
                if(item.initialStock === undefined) { item.initialStock = item.totalStock; }

                await db.updateItem(item);
                const now = new Date(); const localDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                await db.addDispenseLog({ itemId: item.id, itemName: item.name, dispensedQty: qty, remainingQty: item.quantity, unitPrice: item.unitPrice, totalAmount: qty*item.unitPrice, dispenseDate: now.toISOString(), dispenseDateLocal: localDate });
                hideModal(document.getElementById('dispenseModal')); refreshAndRenderTable();
            });

            // --- FUNCTIONALITY FOR BUTTONS ---

            // 1. REPLACEMENTS (Dispense List -> Items Needing Replacement)
            let replacementPage = 1;
            const replacementPerPage = 10; 
            let currentReplacementList = [];

            const renderReplacementList = (list, page) => {
                const tbody = document.getElementById('dispenseListBody');
                tbody.innerHTML = '';
                const totalPages = Math.ceil(list.length / replacementPerPage) || 1;
                replacementPage = Math.min(page, totalPages);
                const start = (replacementPage - 1) * replacementPerPage;
                const pageItems = list.slice(start, start + replacementPerPage);

                if(pageItems.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No items need replacement.</td></tr>';
                }

                pageItems.forEach(i => {
                   const target = i.totalStock !== undefined ? i.totalStock : (i.initialStock || i.quantity); 
                   const needed = target - i.quantity;
                   const row = `<tr>
                       <td>${i.name}</td>
                       <td style="color:red; font-weight:bold;">${i.quantity}</td>
                       <td>${target}</td>
                       <td>${needed}</td>
                       <td><span style="background:#ffc107; padding:2px 6px; border-radius:4px; font-size:11px;">Low Stock</span></td>
                   </tr>`;
                   tbody.innerHTML += row; 
                });

                document.getElementById('dispenseListPageInfo').textContent = `Page ${replacementPage} of ${totalPages}`;
                document.getElementById('dispenseListPrevBtn').disabled = replacementPage === 1;
                document.getElementById('dispenseListNextBtn').disabled = replacementPage === totalPages;
            };

            document.getElementById('dispenseListBtn').addEventListener('click', async () => {
                const items = await db.getAllItems();
                // FILTER: Items where Current Qty < Total Stocks
                currentReplacementList = items.filter(i => {
                    const ts = i.totalStock !== undefined ? i.totalStock : (i.initialStock !== undefined ? i.initialStock : i.quantity);
                    return i.quantity < ts;
                });

                renderReplacementList(currentReplacementList, 1);
                showModal(document.getElementById('dispenseListModal'));
            });

            document.getElementById('dispenseListPrevBtn').addEventListener('click', () => { if(replacementPage > 1) renderReplacementList(currentReplacementList, replacementPage - 1); });
            document.getElementById('dispenseListNextBtn').addEventListener('click', () => { const total = Math.ceil(currentReplacementList.length / replacementPerPage); if(replacementPage < total) renderReplacementList(currentReplacementList, replacementPage + 1); });

            // 2. DISPENSED ITEMS LOG
            let dispensedLogPage = 1;
            const dispensedLogPerPage = 10; 
            let currentDispensedLog = [];

            const renderDispensedLog = (list, page) => {
                const tbody = document.getElementById('dispensedLogBody');
                tbody.innerHTML = '';
                const totalPages = Math.ceil(list.length / dispensedLogPerPage) || 1;
                dispensedLogPage = Math.min(page, totalPages);
                const start = (dispensedLogPage - 1) * dispensedLogPerPage;
                const pageItems = list.slice(start, start + dispensedLogPerPage);
                
                if(pageItems.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No dispensed history found.</td></tr>'; }

                pageItems.forEach(l => {
                    const dateObj = new Date(l.dispenseDate);
                    const row = `<tr><td>${l.itemName}</td><td>${dateObj.toLocaleDateString()}</td><td>${dateObj.toLocaleTimeString()}</td><td>${l.dispensedQty}</td></tr>`;
                    tbody.innerHTML += row;
                });

                document.getElementById('dispensedLogPageInfo').textContent = `Page ${dispensedLogPage} of ${totalPages}`;
                document.getElementById('dispensedLogPrevBtn').disabled = dispensedLogPage === 1;
                document.getElementById('dispensedLogNextBtn').disabled = dispensedLogPage === totalPages;
            };

            document.getElementById('dispensedLogBtn').addEventListener('click', async () => {
                const logs = await db.getAllDispenseLogs();
                currentDispensedLog = logs.sort((a,b) => new Date(b.dispenseDate) - new Date(a.dispenseDate));
                renderDispensedLog(currentDispensedLog, 1);
                showModal(document.getElementById('dispensedLogModal'));
            });

            document.getElementById('dispensedLogPrevBtn').addEventListener('click', () => { if(dispensedLogPage > 1) renderDispensedLog(currentDispensedLog, dispensedLogPage - 1); });
            document.getElementById('dispensedLogNextBtn').addEventListener('click', () => { const total = Math.ceil(currentDispensedLog.length / dispensedLogPerPage); if(dispensedLogPage < total) renderDispensedLog(currentDispensedLog, dispensedLogPage + 1); });

            document.getElementById('downloadDispensedLogPdfBtn').addEventListener('click', () => {
                 if(!currentDispensedLog.length) { alert('No history to print.'); return; }
                 const rows = currentDispensedLog.map(l => {
                    const d = new Date(l.dispenseDate);
                    return [l.itemName, d.toLocaleDateString(), d.toLocaleTimeString(), l.dispensedQty];
                 });
                 generatePDF('Dispensed Items History', ['Item', 'Date', 'Time', 'Qty'], rows);
            });

            // 3. REFILL MONITORING (NEW FEATURE UPDATED)
            let refillLogPage = 1;
            const refillLogPerPage = 10;
            let currentRefillLog = [];

            const renderRefillLog = (list, page) => {
                const tbody = document.getElementById('refillLogBody');
                tbody.innerHTML = '';
                const totalPages = Math.ceil(list.length / refillLogPerPage) || 1;
                refillLogPage = Math.min(page, totalPages);
                const start = (refillLogPage - 1) * refillLogPerPage;
                const pageItems = list.slice(start, start + refillLogPerPage);

                if(pageItems.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No refill records found.</td></tr>'; }

                pageItems.forEach(l => {
                    const d = new Date(l.date);
                    
                    // Format the "Added" column to be specific
                    let addedDisplay = '-';
                    if (l.addedQty > 0) {
                        addedDisplay = `<span style="color:green; font-weight:bold;">+${l.addedQty}</span>`;
                    }

                    const row = `<tr>
                        <td>${l.itemName}</td>
                        <td>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</td>
                        <td>${l.action}</td>
                        <td>${addedDisplay}</td>
                        <td><strong>${l.newQty}</strong></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

                document.getElementById('refillLogPageInfo').textContent = `Page ${refillLogPage} of ${totalPages}`;
                document.getElementById('refillLogPrevBtn').disabled = refillLogPage === 1;
                document.getElementById('refillLogNextBtn').disabled = refillLogPage === totalPages;
            };

            document.getElementById('refillMonitoringBtn').addEventListener('click', async () => {
                const logs = await db.getAllRefillLogs();
                currentRefillLog = logs.sort((a,b) => new Date(b.date) - new Date(a.date));
                renderRefillLog(currentRefillLog, 1);
                showModal(document.getElementById('refillLogModal'));
            });
            
            document.getElementById('refillLogPrevBtn').addEventListener('click', () => { if(refillLogPage > 1) renderRefillLog(currentRefillLog, refillLogPage - 1); });
            document.getElementById('refillLogNextBtn').addEventListener('click', () => { const total = Math.ceil(currentRefillLog.length / refillLogPerPage); if(refillLogPage < total) renderRefillLog(currentRefillLog, refillLogPage + 1); });

            document.getElementById('downloadRefillLogPdfBtn').addEventListener('click', () => {
                 if(!currentRefillLog.length) { alert('No history to print.'); return; }
                 const rows = currentRefillLog.map(l => {
                    const d = new Date(l.date);
                    // Use the detailed action string and precise added quantity
                    return [
                        l.itemName, 
                        `${d.toLocaleDateString()} ${d.toLocaleTimeString()}`, 
                        l.action, 
                        l.addedQty > 0 ? `+${l.addedQty}` : '-', 
                        l.newQty
                    ];
                 });
                 generatePDF('Refill & Stock Adjustment Log', ['Item', 'Date/Time', 'Action / Current No.', 'Added', 'New Qty'], rows);
            });


            // 4. EXPIRATIONS (ONLY SHOW ITEMS EXPIRING IN <= 10 DAYS)
            document.getElementById('expirationBtn').addEventListener('click', async () => {
                const items = await db.getAllItems();
                
                // Calculate Date Threshold: Today + 10 Days
                const today = new Date();
                const targetDate = new Date();
                targetDate.setDate(today.getDate() + 10);
                targetDate.setHours(23, 59, 59, 999);

                const expItems = items.filter(i => {
                    if(!i.expirationDate) return false;
                    const itemDate = new Date(i.expirationDate);
                    // Filter: Date must be less than or equal to target (10 days from now)
                    return itemDate <= targetDate;
                }).sort((a,b) => new Date(a.expirationDate) - new Date(b.expirationDate));

                const tbody = document.getElementById('expirationListBody');
                if (expItems.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No items expiring within 10 days.</td></tr>';
                } else {
                    tbody.innerHTML = expItems.map(i => {
                        return `<tr><td>${i.name}</td><td>${i.expirationDate}</td><td><button class="btn btn-sm btn-danger remove-exp-btn" data-id="${i.id}">Remove</button></td></tr>`;
                    }).join('');
                }
                showModal(document.getElementById('expirationModal'));
            });
            
            document.getElementById('expirationListBody').addEventListener('click', async (e) => {
                 if(e.target.classList.contains('remove-exp-btn')) {
                     if(confirm('Remove this expired item?')) {
                         await db.deleteItem(parseInt(e.target.dataset.id));
                         e.target.closest('tr').remove();
                         refreshAndRenderTable();
                     }
                 }
            });

            // 5. EXPORT/IMPORT
            document.getElementById('exportBtnText').addEventListener('click', async () => {
                const items = await db.getAllItems();
                const logs = await db.getAllDispenseLogs();
                const refillLogs = await db.getAllRefillLogs();
                const data = JSON.stringify({ items, logs, refillLogs }, null, 2);
                try { await navigator.clipboard.writeText(data); alert('Data copied to clipboard successfully!'); } 
                catch(err) { alert('Failed to copy. Please use Export File instead.'); }
            });

            document.getElementById('exportBtnFile').addEventListener('click', async () => {
                const items = await db.getAllItems();
                const logs = await db.getAllDispenseLogs();
                const refillLogs = await db.getAllRefillLogs();
                const data = JSON.stringify({ items, logs, refillLogs }, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `rxstocks_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });

            document.getElementById('importBtnText').addEventListener('click', () => showModal(document.getElementById('importTextModal')));
            document.getElementById('importBtnFile').addEventListener('click', () => document.getElementById('importFileInput').click());

            const processImport = async (jsonString) => {
                try {
                    const data = JSON.parse(jsonString);
                    if(data.items && Array.isArray(data.items)) { await db.bulkAdd('items', data.items); }
                    if(data.logs && Array.isArray(data.logs)) { await db.bulkAdd('dispenseLog', data.logs); }
                    if(data.refillLogs && Array.isArray(data.refillLogs)) { await db.bulkAdd('refillLog', data.refillLogs); }
                    alert(`Import successful!`);
                    refreshAndRenderTable();
                    hideModal(document.getElementById('importTextModal'));
                } catch(e) { console.error(e); alert('Invalid data format or file corruption.'); }
            };

            document.getElementById('loadTextBtn').addEventListener('click', () => { processImport(document.getElementById('importDataText').value); });
            document.getElementById('importFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader(); reader.onload = (e) => processImport(e.target.result); reader.readAsText(file); e.target.value = ''; 
            });

            // 6. PDF HELPER
            const generatePDF = (title, headers, rows) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 20);
                doc.setFontSize(11); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
                doc.autoTable({ startY: 35, head: [headers], body: rows, theme: 'grid' });
                doc.save(`${title.replace(/\s/g, '_')}.pdf`);
            };

            document.getElementById('downloadFullListPdfBtn').addEventListener('click', async () => {
                const items = await db.getAllItems();
                const rows = items.map(i => {
                    const ts = i.totalStock !== undefined ? i.totalStock : (i.initialStock !== undefined ? i.initialStock : i.quantity);
                    return [i.name, i.quantity, ts, i.unitPrice, i.expirationDate, i.registrationDate];
                });
                generatePDF('Full Inventory List', ['Item Name', 'Qty', 'Total Stocks', 'Price', 'Expiry', 'Reg. Date'], rows);
            });

            document.getElementById('downloadDispenseListPdfBtn').addEventListener('click', async () => {
                if(!currentReplacementList || currentReplacementList.length === 0) { alert('No items to print.'); return; }
                const rows = currentReplacementList.map(i => {
                    const target = i.totalStock !== undefined ? i.totalStock : (i.initialStock || i.quantity);
                    return [i.name, i.quantity, target, target-i.quantity];
                });
                generatePDF('Replacement Item List', ['Item', 'Current', 'Total Stocks', 'Needed'], rows);
            });

            document.getElementById('downloadExpirationPdfBtn').addEventListener('click', async () => {
                const items = await db.getAllItems();
                
                // Logic updated to match screen view: <= 10 Days
                const today = new Date();
                const targetDate = new Date();
                targetDate.setDate(today.getDate() + 10);
                targetDate.setHours(23, 59, 59, 999);

                const expItems = items.filter(i => {
                    if(!i.expirationDate) return false;
                    const itemDate = new Date(i.expirationDate);
                    return itemDate <= targetDate;
                }).sort((a,b) => new Date(a.expirationDate) - new Date(b.expirationDate));

                if(expItems.length === 0) { alert('No items expiring within 10 days.'); return; }

                const rows = expItems.map(i => [i.name, i.expirationDate, i.quantity]);
                generatePDF('Expiration Report (Next 10 Days)', ['Item Name', 'Expiry Date', 'Current Qty'], rows);
            });

            // 7. VIEW LIST & DPM
            document.getElementById('viewListBtn').addEventListener('click', async () => {
                const list = await db.getAllItems(); const c = document.getElementById('fullItemList'); 
                c.innerHTML = list.length ? `<ul>${list.map(i=>`<li><strong>${i.name}</strong> - Qty: ${i.quantity} (Exp: ${i.expirationDate || 'N/A'})</li>`).join('')}</ul>` : '<p>Empty</p>';
                showModal(document.getElementById('viewListModal'));
            });

            document.getElementById('dpmBtn').addEventListener('click', () => { document.getElementById('dpmContent').innerHTML='<p style="text-align:center;color:#666;">Please select a date to view movement.</p>'; showModal(document.getElementById('dpmModal')); });
            
            document.getElementById('dpmDateBtn').addEventListener('click', async () => {
                const d = document.getElementById('dpmDateInput').value; if(!d) return;
                const logs = await db.getDispenseLogByDate(d); const c = document.getElementById('dpmContent');
                if(!logs.length) { c.innerHTML='<p style="text-align:center;">No records for this date.</p>'; return; }
                c.innerHTML = `<table style="width:100%;border-collapse:collapse;margin-top:10px;"><thead><tr style="background:#eee;"><th style="padding:8px;border:1px solid #ddd;">Item</th><th style="padding:8px;border:1px solid #ddd;">Qty</th><th style="padding:8px;border:1px solid #ddd;">Total</th></tr></thead><tbody>${logs.map(l=>`<tr><td style="padding:8px;border:1px solid #ddd;">${l.itemName}</td><td style="padding:8px;border:1px solid #ddd;">${l.dispensedQty}</td><td style="padding:8px;border:1px solid #ddd;">â‚±${l.totalAmount.toFixed(2)}</td></tr>`).join('')}</tbody></table>`;
            });

            // Start
            await db.init(); await checkExpirationOnLoad(); updateTimestamp(); setInterval(updateTimestamp, 1000);
            if (sessionStorage.getItem('loggedIn') === 'true') { showInventoryPage(); await refreshAndRenderTable(); } else showLoginPage();
        });
    </script>
</body>
</html>